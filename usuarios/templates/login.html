{% load static %}
<!DOCTYPE html>
<html lang="es" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar sesión - Nuevas Energías</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Script para evitar el "flash" del tema incorrecto (FOUC)
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .dark ::-webkit-scrollbar { width: 12px; }
        .dark ::-webkit-scrollbar-track { background: #1F2937; }
        .dark ::-webkit-scrollbar-thumb { background-color: #4B5563; border-radius: 20px; border: 3px solid #1F2937; }
        * { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white dark:bg-gray-800 shadow-lg rounded-lg p-8 m-4">
            <div class="text-center mb-8">
                <img src="{% static 'images/logo-nuevas-energias-v2.png' %}" alt="Logo" class="mx-auto h-20 w-auto">
                <h2 class="mt-6 text-3xl font-extrabold text-gray-900 dark:text-white">
                    Iniciar sesión
                </h2>
            </div>

            {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert" id="bloqueo-msg">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline">{{ error|safe }}</span>
            </div>
            {% endif %}

            <form method="post" novalidate class="space-y-6">
                {% csrf_token %}
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Nombre de usuario
                    </label>
                    <div class="mt-1">
                        <input type="text" id="username" name="username" required
                            class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                            placeholder="Ingrese su nombre de usuario" {% if bloqueado %}disabled{% endif %}>
                    </div>
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Contraseña
                    </label>
                    <div class="mt-1 relative">
                        <input type="password" id="password" name="password" required
                            class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                            placeholder="Ingrese su contraseña" {% if bloqueado %}disabled{% endif %}>
                        <button type="button" id="togglePassword"
                            class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                            tabindex="-1">
                            <span id="icon-eye">
                                <!-- El SVG se insertará aquí mediante JavaScript -->
                            </span>
                        </button>
                    </div>
                </div>

                {% if not bloqueado %}
                <div>
                    <button type="submit"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Ingresar
                    </button>
                </div>
                {% endif %}
            </form>

            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    ¿No tienes cuenta?
                    <a href="{% url 'register' %}" class="font-medium text-red-600 hover:text-red-500">
                        Regístrate aquí
                    </a>
                </p>
            </div>
        </div>
    </div>

    {% if error %}
    <script>
        let tiempoElem = document.getElementById('tiempo-bloqueo');
        let alertaElem = document.getElementById('bloqueo-msg');
        if (tiempoElem) {
            let regex = /(\d+)\s*m\s+y\s*(\d+)\s*s/;
            let match = tiempoElem.innerText.match(regex);
            if (match) {
                let minutos = parseInt(match[1]);
                let segundos = parseInt(match[2]);
                let total = minutos * 60 + segundos;
                let intervalo = setInterval(function () {
                    if (total <= 0) {
                        clearInterval(intervalo);
                        location.reload();
                        return;
                    }
                    total--;
                    let m = Math.floor(total / 60);
                    let s = total % 60;
                    tiempoElem.innerText = m + ' m y ' + s + ' s';
                }, 1000);
            }
        }
    </script>
    {% endif %}

    <script>
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        const iconEye = document.getElementById('icon-eye');

        const eyeOpenSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye">
                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                <circle cx="12" cy="12" r="3" />
            </svg>`;
        const eyeClosedSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off">
                <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" />
                <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" />
                <line x1="2" x2="22" y1="2" y2="22" />
            </svg>`;

        if (togglePassword && passwordInput && iconEye) {
            // Default to password hidden (closed eye)
            iconEye.innerHTML = eyeClosedSVG;

            togglePassword.addEventListener('click', function () {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    iconEye.innerHTML = eyeOpenSVG;
                } else {
                    passwordInput.type = 'password';
                    iconEye.innerHTML = eyeClosedSVG;
                }
            });
        }
    </script>
    <script src="{% static 'js/app.js' %}"></script>
</body>

</html>