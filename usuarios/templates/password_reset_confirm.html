{% load static %}
{% load string_filters %}
<!DOCTYPE html>
<html lang="es" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Contraseña - Nuevas Energías</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white dark:bg-gray-800 shadow-lg rounded-lg p-8 m-4">
            {% if validlink %}
                <h2 class="text-center text-3xl font-extrabold text-gray-900 dark:text-white">
                    Ingresa tu nueva contraseña
                </h2>
                <form method="post" class="mt-8 space-y-6" id="password-reset-form" novalidate>
                    {% csrf_token %}

                    {% for field in form %}
                        <div>
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                {% if field.name == 'new_password1' %}
                                    Nueva contraseña
                                {% elif field.name == 'new_password2' %}
                                    Confirmar nueva contraseña
                                {% else %}
                                    {{ field.label }}
                                {% endif %}
                            </label>
                            <div class="mt-1 relative">
                                <input type="password" name="{{ field.name }}" id="{{ field.id_for_label }}"
                                    class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                                    required>
                                <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 toggle-password" tabindex="-1">
                                    <!-- Icono se insertará con JS -->
                                </button>
                            </div>
                            {% if field.help_text %}
                                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">{{ field.help_text|safe }}</p>
                            {% endif %}
                            {% for error in field.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endfor %}

                    <!-- Mensaje de error para la confirmación de contraseña -->
                    <div id="password-match-error" class="hidden mt-2 text-sm text-red-600 dark:text-red-400">
                        Las contraseñas no coinciden.
                    </div>

                    <!-- Errores no asociados a un campo específico -->
                    {% if form.non_field_errors %}
                        {% for error in form.non_field_errors %}
                            <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                        {% endfor %}
                    {% endif %}

                    <button type="submit" id="submit-button"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Cambiar mi contraseña
                    </button>
                </form>
            {% else %}
                <div class="text-center">
                    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">
                        Enlace Inválido
                    </h2>
                    <p class="mt-4 text-gray-600 dark:text-gray-400">
                        El enlace para restablecer la contraseña es inválido, posiblemente porque ya ha sido utilizado. Por favor, solicita un nuevo restablecimiento de contraseña.
                    </p>
                    <div class="mt-8">
                        <a href="{% url 'password_reset' %}"
                            class="w-full inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Solicitar Nuevo Enlace
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('password-reset-form');
            if (!form) return;

            const passwordInput = document.getElementById('id_new_password1');
            const confirmInput = document.getElementById('id_new_password2');
            const matchError = document.getElementById('password-match-error');
            const submitButton = document.getElementById('submit-button');

            function validatePasswords() {
                const passwordsMatch = passwordInput.value === confirmInput.value;
                const isConfirmEmpty = confirmInput.value === '';

                if (passwordsMatch || isConfirmEmpty) {
                    matchError.classList.add('hidden');
                    confirmInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    confirmInput.classList.add('border-gray-300', 'dark:border-gray-600');
                } else {
                    matchError.classList.remove('hidden');
                    confirmInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    confirmInput.classList.remove('border-gray-300', 'dark:border-gray-600');
                }

                // Habilitar el botón solo si las contraseñas no están vacías y coinciden
                submitButton.disabled = !passwordsMatch || passwordInput.value === '';
            }

            passwordInput.addEventListener('input', validatePasswords);
            confirmInput.addEventListener('input', validatePasswords);

            // Toggle password visibility
            const eyeOpenSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>`;
            const eyeClosedSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" /><line x1="2" x2="22" y1="2" y2="22" /></svg>`;

            document.querySelectorAll('.toggle-password').forEach(button => {
                const input = button.previousElementSibling;
                button.innerHTML = eyeClosedSVG; // Default state

                button.addEventListener('click', function () {
                    if (input.type === 'password') {
                        input.type = 'text';
                        button.innerHTML = eyeOpenSVG;
                    } else {
                        input.type = 'password';
                        button.innerHTML = eyeClosedSVG;
                    }
                });
            });

            // Estado inicial del botón
            validatePasswords();
        });
    </script>
</body>
</html>