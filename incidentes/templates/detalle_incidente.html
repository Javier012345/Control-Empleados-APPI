{% extends 'base.html' %}
{% load auth_extras %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    {% if user|has_group:"Administrador" %}
    <a href="{{ request.META.HTTP_REFERER|default_if_none:request.build_absolute_uri }}" class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500 mb-6">
        <i data-lucide="arrow-left"></i> Volver
    </a>
    {% else %}
    <a href="{% url 'mis_incidentes' %}" class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500 mb-6">
        <i data-lucide="arrow-left"></i> Volver a Mis Incidentes
    </a>
    {% endif %}
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-start">
            <h2 class="text-2xl font-bold mb-4">Detalle del Incidente</h2>
            <div class="flex items-center gap-2">
                {% if corrected_incident_id %}
                    <a href="{% url 'detalle_incidente' corrected_incident_id %}" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-emerald-700 text-sm">
                        <i data-lucide="history" class="w-4 h-4"></i> Ver Incidente Original
                    </a>
                {% endif %}
                {% if not resolucion and not view_as_employee and user|has_group:'Administrador' %}
                <a href="{% url 'corregir_incidente' incidente.id %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700"><i data-lucide="pencil" class="w-4 h-4"></i>Corregir</a>
                {% endif %}
                <a href="{% url 'generar_incidente_pdf' incidente.id %}" target="_blank" class="bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-700 text-sm">
                    <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
                </a>
            </div>
        </div>

        <div class="space-y-4">
            <div><h4 class="text-sm font-semibold text-gray-500">Nombre del Incidente</h4><p>{{ incidente.tipo_incid }}</p></div>
            <div><h4 class="text-sm font-semibold text-gray-500">Fecha</h4><p>{{ fecha_incidente|date:"d/m/Y" }}</p></div>
            <div><h4 class="text-sm font-semibold text-gray-500">Descripción</h4><p class="text-gray-600 dark:text-gray-300">{{ incidente.descripcion_incid }}</p></div>
            
            <div>
                <h4 class="text-sm font-semibold text-gray-500 mb-2">Empleados Involucrados</h4>
                <div class="space-y-2">
                    {% for involucrado in involucrados %}
                        <div class="flex items-center justify-between p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
                            <div class="flex items-center gap-3">
                                <div>
                                    <p class="font-semibold text-sm">{{ involucrado.id_empl.nombre }} {{ involucrado.id_empl.apellido }}</p>
                                    <p class="text-xs text-gray-500">{{ involucrado.id_empl.dni }}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                {% if involucrado.ya_sancionado %}
                                    <span class="text-xs font-semibold text-green-600 bg-green-100 dark:text-green-200 dark:bg-green-900 px-2 py-1 rounded-full">Sancionado</span>
                                {% elif involucrado.estado == 'CERRADO' %}
                                    <span class="text-xs font-semibold text-red-600 bg-red-100 dark:text-red-200 dark:bg-red-900 px-2 py-1 rounded-full">Cerrado</span>
                                {% else %}
                                    <span class="text-xs font-semibold text-yellow-600 bg-yellow-100 dark:text-yellow-200 dark:bg-yellow-900 px-2 py-1 rounded-full">Pendiente</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <h4 class="text-sm font-semibold text-gray-500 mt-6 mb-3">Historial del Caso</h4>
        <ol class="relative border-l border-gray-200 dark:border-gray-700 ml-2">
            <li class="mb-6 ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white dark:ring-gray-800 dark:bg-blue-900">
                    <i data-lucide="file-plus" class="w-3 h-3 text-blue-800 dark:text-blue-300"></i>
                </span>
                <h3 class="flex items-center mb-1 text-md font-semibold text-gray-900 dark:text-white">Incidente Reportado</h3>
                <time class="block mb-2 text-sm font-normal leading-none text-gray-400 dark:text-gray-500">Reportado el {{ fecha_incidente|date:"d/m/Y" }}</time>
            </li>

            {% if descargos %}
            <li class="mb-6 ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-cyan-100 rounded-full -left-3 ring-8 ring-white dark:ring-gray-800 dark:bg-cyan-900">
                    <i data-lucide="message-square" class="w-3 h-3 text-cyan-800 dark:text-cyan-300"></i>
                </span>
                <h3 class="text-md font-semibold text-gray-900 dark:text-white">Descargos Recibidos</h3>
                {% for item in descargos %}
                <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <p class="text-sm font-semibold">{{ item.empleado.nombre }} {{ item.empleado.apellido }}</p>
                        <time class="text-xs text-gray-400 dark:text-gray-500 ml-auto">{{ item.descargo.fecha_descargo|date:"d/m/Y" }}</time>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 italic">"{{ item.descargo.contenido_descargo }}"</p>
                    {% if item.descargo.ruta_archivo_descargo %}
                    <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                        <a href="{{ item.descargo.ruta_archivo_descargo.url }}" class="flex items-center gap-2 text-xs text-blue-600 hover:underline">
                            <i data-lucide="paperclip" class="w-3 h-3"></i><span>Archivo Adjunto</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </li>
            {% else %}
            <li class="mb-6 ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-gray-100 rounded-full -left-3 ring-8 ring-white dark:ring-gray-800 dark:bg-gray-700">
                    <i data-lucide="message-square" class="w-3 h-3 text-gray-500"></i>
                </span>
                <h3 class="text-md font-semibold text-gray-500 dark:text-gray-400">Sin Descargos</h3>
                <p class="text-sm font-normal text-gray-500 dark:text-gray-400">No se han registrado descargos de los involucrados.</p>
            </li>
            {% endif %}

            {% if resolucion %}
            <li class="ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-green-100 rounded-full -left-3 ring-8 ring-white dark:ring-gray-800 dark:bg-green-900">
                    <i data-lucide="gavel" class="w-3 h-3 text-green-800 dark:text-green-300"></i>
                </span>
                <h3 class="text-md font-semibold text-gray-900 dark:text-white">Incidente Resuelto</h3>
                <time class="block mb-2 text-sm font-normal leading-none text-gray-400 dark:text-gray-500">Resuelto el {{ resolucion.fecha_resolucion|date:"d/m/Y" }}</time>
                <p class="text-sm font-normal text-gray-500 dark:text-gray-400">{{ resolucion.descripcion }}</p>
            </li>
            {% else %}
            <li class="ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-gray-100 rounded-full -left-3 ring-8 ring-white dark:ring-gray-800 dark:bg-gray-700">
                    <i data-lucide="gavel" class="w-3 h-3 text-gray-800 dark:text-gray-300"></i>
                </span>
                <h3 class="text-md font-semibold text-gray-500 dark:text-gray-400">Resolución Pendiente</h3>
            </li>
            {% endif %}
        </ol>

        {% if not resolucion and not view_as_employee and user|has_group:'Administrador' %}
        <div id="incident-actions-container" class="mt-8 pt-6 border-t dark:border-gray-700">
            <div class="flex justify-end">
                <button onclick="openModal('resolve-incident-modal')" class="bg-red-600 text-white px-6 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-red-700">
                    <i data-lucide="gavel"></i><span>Registrar Resolución</span>
                </button>
            </div>
        </div>
        {% endif %}

        {% if descargo_form and current_incidente_empleado and not current_incidente_empleado.id_descargo %}
        <div class="mt-8 pt-6 border-t dark:border-gray-700">
            <h3 class="text-lg font-semibold mb-4">Registrar Descargo</h3>
            <form method="post" action="{% url 'detalle_incidente' incidente.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label for="{{ descargo_form.contenido_descargo.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ descargo_form.contenido_descargo.label }}</label>
                        {{ descargo_form.contenido_descargo }}
                    </div>
                    <div>
                        <label for="{{ descargo_form.ruta_archivo_descargo.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Adjuntar Archivo (Opcional)</label>
                        {{ descargo_form.ruta_archivo_descargo }}
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Enviar Descargo</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block modals %}
{% if user|has_group:'Administrador' %}
<div id="resolve-incident-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg p-6 m-4" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between pb-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold">Registrar Resolución de Incidente</h2>
            <button onclick="closeModal('resolve-incident-modal')" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="x"></i></button>
        </div>
        <form method="post" action="{% url 'resolver_incidente' incidente.id %}" class="mt-6 space-y-4">
            {% csrf_token %}
            <div>
                <label for="{{ resolucion_form.descripcion.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ resolucion_form.descripcion.label }}</label>
                {{ resolucion_form.descripcion }}
            </div>
            <div class="pt-4 flex flex-col sm:flex-row justify-end gap-3">
                <button type="submit" name="action" value="cerrar" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Solo Cerrar Incidente</button>
                <button type="submit" name="action" value="sancionar" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2"><i data-lucide="shield-plus"></i>Guardar y Aplicar Sanción</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock modals %}

{% block page_scripts %}
<script>
    lucide.createIcons();
    // Añade clases a los textarea generados por Django
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('textarea').forEach(field => {
            field.classList.add('mt-1', 'block', 'w-full', 'rounded-md', 'border-gray-300', 'dark:border-gray-600', 'dark:bg-gray-700', 'shadow-sm', 'text-black', 'dark:text-white');
        });
    });
</script>
{% endblock %}