{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Empleados{% endblock %}

{% block page_title %}Gestión de Empleados{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex flex-col sm:flex-row items-center gap-2 w-full sm:w-auto flex-grow">
        <div class="relative w-full sm:max-w-xs">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
            <input type="text" id="search-input" placeholder="Buscar por nombre o DNI..." class="w-full pl-10 pr-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600">
        </div>
        
        <select id="estado-filter" class="w-full sm:w-auto py-2 px-4 rounded-lg border dark:bg-gray-700 dark:border-gray-600">
            <option value="">Todos los Estados</option>
            {% for value, display in estado_choices %}
            <option value="{{ value }}">{{ display }}</option>
            {% endfor %}
        </select>

        <select id="cargo-filter" class="w-full sm:w-auto py-2 px-4 rounded-lg border dark:bg-gray-700 dark:border-gray-600">
            <option value="">Todos los Cargos</option>
            {% for cargo in cargos %}
            <option value="{{ cargo.id }}">{{ cargo.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-2">
        <a href="{% url 'generar_lista_empleados_pdf' %}" target="_blank" class="w-full sm:w-auto flex-shrink-0 bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-700 text-sm">
            <i data-lucide="printer" class="w-4 h-4"></i> Imprimir Lista
        </a>
        <a href="{% url 'crear_empleado' %}" class="w-full sm:w-auto flex-shrink-0 bg-red-600 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-red-700">
            <i data-lucide="plus"></i><span>Registrar Empleado</span>
        </a>
    </div>
</div>

<div id="employee-list">
    {% include 'lista_empleados.html' %}
</div>
<!-- Contenedor donde colocaremos la paginación al final de la página -->
<div id="page-bottom-pagination" class="mt-6 px-4 sm:px-6"></div>
{% endblock content %}

{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const { computePosition, flip, shift, offset, autoUpdate } = FloatingUIDOM;
        let activeCleanup = null;

        // --- Búsqueda y Filtro de Empleados (AJAX) ---
        const searchInput = document.getElementById('search-input');
        const estadoFilter = document.getElementById('estado-filter');
        const cargoFilter = document.getElementById('cargo-filter');
        const employeeListContainer = document.getElementById('employee-list');
        const bottomPagination = document.getElementById('page-bottom-pagination');

        function movePagination() {
            const pagination = employeeListContainer.querySelector('#employee-pagination');
            if (pagination && bottomPagination) {
                bottomPagination.innerHTML = '';
                bottomPagination.appendChild(pagination);
            } else if (bottomPagination) {
                bottomPagination.innerHTML = ''; // Limpiar si no hay paginación
            }
        }

        function performSearch() {
            const query = searchInput.value;
            const estado = estadoFilter.value;
            const cargo = cargoFilter.value;
            
            // Construir la URL con parámetros de consulta
            const url = `{% url 'buscar_empleados' %}?q=${encodeURIComponent(query)}&estado=${encodeURIComponent(estado)}&cargo=${encodeURIComponent(cargo)}`;
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    employeeListContainer.innerHTML = html;
                    movePagination();
                });
        }

        // Mover paginación inicial al cargar la página
        movePagination();

        // Listeners para los filtros y la búsqueda
        searchInput.addEventListener('keyup', performSearch);
        estadoFilter.addEventListener('change', performSearch);
        cargoFilter.addEventListener('change', performSearch);

        // --- Lógica de Menús y Notificaciones (Event Delegation) ---
        document.body.addEventListener('click', function(e) {
            const toggleButton = e.target.closest('[data-action="toggle-menu"]');
            const deleteButton = e.target.closest('[data-action="delete-employee"]');

            // --- Manejo de Menús Desplegables ---
            if (toggleButton) {
                e.preventDefault();
                const menu = toggleButton.nextElementSibling;

                if (activeCleanup && activeCleanup.menu === menu) {
                    activeCleanup();
                    activeCleanup = null;
                    return;
                }

                if (activeCleanup) {
                    activeCleanup();
                    activeCleanup = null;
                }

                menu.classList.remove('hidden');
                const cleanup = autoUpdate(toggleButton, menu, () => {
                    computePosition(toggleButton, menu, {
                        placement: 'bottom-end',
                        middleware: [
                            offset(8),
                            flip(),
                            shift({ padding: 8 })
                        ]
                    }).then(({ x, y }) => {
                        Object.assign(menu.style, {
                            left: `${x}px`,
                            top: `${y}px`,
                        });
                    });
                });

                activeCleanup = () => {
                    cleanup();
                    menu.classList.add('hidden');
                };
                activeCleanup.menu = menu;

            } else if (deleteButton) {
                e.preventDefault();
                const url = deleteButton.href;
                showNotification('warning', '¿Estás seguro?',
                    `Esta acción no se puede deshacer. <br><br> <a href="${url}" class="font-bold text-red-600 hover:underline">Sí, eliminar</a>`,
                    10000
                );
            } else if (!e.target.closest('[data-menu]')) {
                if (activeCleanup) {
                    activeCleanup();
                    activeCleanup = null;
                }
            }
        });
    });
</script>
{% endblock page_scripts %}
