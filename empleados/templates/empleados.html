{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Empleados{% endblock %}

{% block page_title %}Gestión de Empleados{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
    <div class="relative w-full sm:max-w-xs">
        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
        <input type="text" id="search-input" placeholder="Buscar por nombre o DNI..." class="w-full pl-10 pr-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600">
    </div>
    <a href="{% url 'crear_empleado' %}" class="w-full sm:w-auto flex-shrink-0 bg-red-600 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-red-700">
        <i data-lucide="plus"></i>
        <span>Registrar Empleado</span>
    </a>
</div>

<div id="employee-list">
    {% include 'lista_empleados.html' %}
</div>
<!-- Contenedor donde colocaremos la paginación al final de la página -->
<div id="page-bottom-pagination" class="mt-6 px-4 sm:px-6"></div>
{% endblock content %}

{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const { computePosition, flip, shift, offset, autoUpdate } = FloatingUIDOM;
        let activeCleanup = null;

        // --- Búsqueda de Empleados (AJAX) ---
        const searchInput = document.getElementById('search-input');
        const employeeListContainer = document.getElementById('employee-list');
            const bottomPagination = document.getElementById('page-bottom-pagination');

            // Al cargar, mover la paginación inicial (si existe) al fondo
            const initialPagination = employeeListContainer.querySelector('#employee-pagination');
            if (initialPagination && bottomPagination) {
                bottomPagination.innerHTML = '';
                bottomPagination.appendChild(initialPagination);
            }

            searchInput.addEventListener('keyup', function() {
                const query = searchInput.value;
                fetch(`{% url 'buscar_empleados' %}?q=${query}`)
                    .then(response => response.text())
                    .then(html => {
                        employeeListContainer.innerHTML = html;
                        // extraer paginación del HTML recibido y moverla al fondo
                        const temp = document.createElement('div');
                        temp.innerHTML = html;
                        const pagination = temp.querySelector('#employee-pagination');
                        if (pagination && bottomPagination) {
                            bottomPagination.innerHTML = '';
                            bottomPagination.appendChild(pagination);
                        }
                    });
            });

        // --- Lógica de Menús y Notificaciones (Event Delegation) ---
        document.body.addEventListener('click', function(e) {
            const toggleButton = e.target.closest('[data-action="toggle-menu"]');
            const deleteButton = e.target.closest('[data-action="delete-employee"]');

            // --- Manejo de Menús Desplegables ---
            if (toggleButton) {
                e.preventDefault();
                const menu = toggleButton.nextElementSibling;

                // Si se hace clic en el botón de un menú que ya está activo, lo cerramos.
                if (activeCleanup && activeCleanup.menu === menu) {
                    activeCleanup(); // Llama a la función de limpieza completa
                    activeCleanup = null; // Limpia la referencia
                    return; // Salimos para evitar que se vuelva a abrir.
                }

                // Si hay otro menú activo, lo cerramos primero.
                if (activeCleanup) {
                    activeCleanup();
                    activeCleanup = null;
                }

                // Abrimos el nuevo menú.
                menu.classList.remove('hidden');
                const cleanup = autoUpdate(toggleButton, menu, () => {
                    computePosition(toggleButton, menu, {
                        placement: 'bottom-end',
                        middleware: [
                            offset(8),
                            flip(),
                            shift({ padding: 8 })
                        ]
                    }).then(({ x, y }) => {
                        Object.assign(menu.style, {
                            left: `${x}px`,
                            top: `${y}px`,
                        });
                    });
                });

                // Guardamos la referencia al menú y su función de limpieza.
                activeCleanup = () => {
                    cleanup();
                    menu.classList.add('hidden');
                };
                activeCleanup.menu = menu; // Adjuntamos el elemento del menú para poder compararlo.

            } else if (deleteButton) {
                // --- Manejo de Notificación de Eliminación ---
                e.preventDefault();
                const url = deleteButton.href;
                showNotification('warning', '¿Estás seguro?',
                    `Esta acción no se puede deshacer. <br><br> <a href="${url}" class="font-bold text-red-600 hover:underline">Sí, eliminar</a>`,
                    10000
                );
            } else if (!e.target.closest('[data-menu]')) {
                // --- Cerrar menú si se hace clic afuera ---
                if (activeCleanup) {
                    activeCleanup();
                    activeCleanup = null;
                }
            }
        });
    });
</script>
{% endblock page_scripts %}